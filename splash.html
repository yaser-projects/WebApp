<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metal Brain - Connecting</title>
  <link rel="stylesheet" href="css/common-style.css">
  <style>
    .splash-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }

    .splash-logo {
      font-size: 3rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 12px;
      letter-spacing: 0.1em;
    }

    .splash-subtitle {
      font-size: 1rem;
      color: var(--text-muted);
      margin-bottom: 40px;
    }

    .splash-status {
      margin-top: 30px;
      padding: 12px 24px;
      background: rgba(5, 208, 197, 0.1);
      border: 1px solid var(--accent-soft);
      border-radius: var(--radius);
      color: var(--accent);
      font-size: 0.9rem;
    }

    .splash-spinner {
      margin: 30px 0;
    }
  </style>
</head>
<body>
  <div class="splash-container">
    <div class="splash-logo">METAL BRAIN</div>
    <p class="splash-subtitle">Professional Embedded & Web UI System</p>
    
    <div class="splash-spinner">
      <div class="spinner"></div>
    </div>

    <div class="splash-status" id="statusText">
      Detecting connection type...
    </div>
  </div>

  <script type="module">
    import { connectWebSocket } from './js/ws.js';

    const statusText = document.getElementById('statusText');
    let connectionType = 'unknown';
    let redirectPath = 'index.html';

    // Update status message
    function updateStatus(message) {
      statusText.textContent = message;
    }

    // Try to connect and detect endpoint
    const ws = connectWebSocket({
      onOpen: () => {
        const url = ws.ws?.url || 'device';
        if (url.includes('192.168.1.2') || url.includes('192.168.4.1')) {
          connectionType = 'direct';
          updateStatus('Connected to device (Direct/AP mode)');
        } else if (url.includes('localhost') || url.includes('127.0.0.1')) {
          connectionType = 'local';
          updateStatus('Connected to local server');
        } else {
          connectionType = 'network';
          updateStatus('Connected via network');
        }

        // Check if device is in setup mode (AP SSID = "Metal Brain")
        ws.sendJSON({
          setting: "device",
          action: "read",
          fields: ["AP SSID"]
        });
      },

      onJSON: (data) => {
        if (data['AP SSID'] !== undefined) {
          const apSsid = data['AP SSID'];
          if (apSsid === 'Metal Brain') {
            redirectPath = 'quickstart.html';
          } else {
            redirectPath = 'index.html';
          }
          
          // Small delay then redirect
          setTimeout(() => {
            window.location.href = redirectPath;
          }, 500);
        }
      },

      onError: () => {
        updateStatus('Connection error. Redirecting to login...');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      },

      onClose: () => {
        // If closed before redirect, go to login
        if (redirectPath === 'index.html') {
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1000);
        }
      }
    });

    // Timeout fallback: redirect to login after 5 seconds
    setTimeout(() => {
      if (redirectPath === 'index.html') {
        window.location.href = 'index.html';
      }
    }, 5000);
  </script>
</body>
</html>

