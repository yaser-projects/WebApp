<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Start - Metal Brain</title>

  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/quickstart.css">
</head>

<body>

  <script>
    // Lightweight probe: attempt to read device AP SSID, but don't block the UI when probe fails.
    (function() {
      // If already authenticated via prior login, allow immediately
      if (sessionStorage.getItem('metalbrain-auth') === 'ok') return;

      // create a small banner to show probe errors (hidden by default)
      const warnId = 'qsWarning';
      let warnEl = document.getElementById(warnId);
      if (!warnEl) {
        warnEl = document.createElement('div');
        warnEl.id = warnId;
        warnEl.style.cssText = 'background:#4b2; color:#fff; padding:8px 12px; border-radius:6px; display:none; margin:10px auto; max-width:800px; text-align:center;';
        warnEl.textContent = 'Cannot contact device; QuickStart may not work until you are connected to the device.';
        const container = document.querySelector('.qs-container') || document.body;
        container.parentNode.insertBefore(warnEl, container);
      }

      const proto = location.protocol === 'https:' ? 'wss://' : 'ws://';
      let ws;
      try {
        ws = new WebSocket(proto + location.host + '/ws');
      } catch (e) {
        // don't redirect ‚Äî just show a warning and allow user to continue
        warnEl.style.display = 'block';
        return;
      }

      // If no response in 5s, show warning and allow the page
      const to = setTimeout(() => {
        try { ws.close(); } catch (e) {}
        warnEl.style.display = 'block';
      }, 5000);

      ws.onopen = () => {
        try { ws.send(JSON.stringify({ setting: 'device', action: 'read', fields: ['AP SSID'] })); } catch (e) { /* ignore */ }
      };

      ws.onmessage = (ev) => {
        clearTimeout(to);
        let data;
        try { data = JSON.parse(ev.data); } catch (e) { data = null; }

        try { ws.close(); } catch (e) {}

        if (data && typeof data['AP SSID'] !== 'undefined') {
          if (data['AP SSID'] === 'Metal Brain') {
            // device in setup mode ‚Äî allow QuickStart
            return;
          }
          // device configured -> go to dashboard
          window.location.href = 'dashboard.html';
        } else {
          // unexpected response -> show warning and allow the page
          warnEl.style.display = 'block';
        }
      };

      ws.onerror = () => {
        clearTimeout(to);
        try { ws.close(); } catch (e) {}
        warnEl.style.display = 'block';
      };
    })();
  </script>

  <div class="qs-container">

    <!-- ÿπŸÜŸàÿßŸÜ ÿµŸÅÿ≠Ÿá -->
    <h1>Quick Start</h1>
    <p class="qs-sub">Setup your Metal Brain device in 5 steps</p>

    <!-- ⁄©ÿßÿ±ÿ™ -->
    <div class="qs-card">

      <!-- STEP 1 -->
      <div class="qs-step active" id="step1">
        <fieldset>
          <legend>Start Config</legend>
          <div class="step-content">
            <p>Welcome! This wizard will guide you through the main setup tasks:</p>
            <ol>
              <li>Configure device Access Point</li>
              <li>Connect to your Modem (Station)</li>
              <li>Select operating modes (AP/STA)</li>
              <li>Review and finish</li>
            </ol>
          </div>
        </fieldset>
        <div class="step-actions right">
          <button class="btn primary" id="startBtn">Start</button>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="qs-step" id="step2">
        <fieldset>
          <legend>Access Point</legend>

          <div class="qs-field-inline">
            <label for="apHidden">Hidden Network</label>
            <input id="apHidden" type="checkbox">
          </div>

          <div class="qs-field stacked">
            <label for="apSsid">SSID</label>
            <div class="input-wrap">
              <span class="icon">üì∂</span>
              <input id="apSsid" type="text" minlength="1" maxlength="32" required placeholder="Device SSID">
            </div>
            <small class="error" id="apSsidError"></small>
          </div>

          <div class="qs-field stacked">
            <label for="apPass">Pre-Shared Key (8-64 chars)</label>
            <div class="input-wrap">
              <span class="icon">üîë</span>
              <input id="apPass" type="text" minlength="8" maxlength="64" required placeholder="8-64 characters">
            </div>
            <small class="error" id="apPassError"></small>
          </div>
        </fieldset>

        <div class="step-actions">
          <button class="btn primary" id="saveAp">Next</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="qs-step" id="step3">
        <fieldset>
          <legend>Station Mode</legend>

          <div class="qs-field-inline">
            <input id="staHasInternet" type="checkbox">
            <label for="staHasInternet">I have internet</label>
          </div>

          <div class="qs-field">
            <label for="staNetworks">Modem SSID</label>
            <div class="input-wrap">
              <span class="icon">üì°</span>
              <select id="staNetworks" disabled>
                <option value="">(Select or type)</option>
              </select>
            </div>
            <small class="error" id="staNetError"></small>
          </div>

          <div class="qs-field">
            <label for="staPass">Modem Pre-Shared Key (0-64 chars)</label>
            <div class="input-wrap">
              <span class="icon">üîí</span>
              <input id="staPass" type="text" minlength="0" maxlength="64" disabled placeholder="Optional">
            </div>
            <small class="error" id="staPassError"></small>
          </div>
        </fieldset>

        <div class="step-actions">
          <button class="btn primary" id="saveSta">Next</button>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="qs-step" id="step4">
        <fieldset>
          <legend>Select Mode</legend>

          <div class="qs-field-inline">
            <input type="checkbox" id="modeAp">
            <label for="modeAp">üõ∞Ô∏è Access Point</label>
          </div>

          <div class="qs-field-inline">
            <input type="checkbox" id="modeSta">
            <label for="modeSta">üì° Station</label>
          </div>
          <small class="error" id="selectModeError"></small>
        </fieldset>

        <div class="step-actions">
          <button class="btn primary" id="nextToStep5">Next</button>
        </div>
      </div>

      <!-- STEP 5 -->
      <div class="qs-step" id="step5">
        <fieldset>
          <legend>Device Config</legend>
          <div class="summary-table">
            <dl>
              <dt>Device SSID:</dt><dd id="summaryAPSSID">-</dd>
              <dt>Device PSK:</dt><dd id="summaryAPPsk">-</dd>
              <dt>Modem SSID:</dt><dd id="summaryModemSSID">-</dd>
              <dt>Modem PSK:</dt><dd id="summaryModemPsk">-</dd>
              <dt>Mode:</dt><dd id="summaryMode">-</dd>
            </dl>
          </div>
        </fieldset>

        <div class="step-actions">
          <button class="btn primary" id="finishBtn">Finish</button>
        </div>
      </div>

    </div>

    <!-- ⁄ØÿßŸÖ Ÿáÿß -->
    <div class="qs-dots">
      <span class="dot active"></span>
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </div>

  </div>

  <script src="js/quickstart.js"></script>
</body>
</html>
